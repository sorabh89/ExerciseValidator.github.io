<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Takat Exercises Editor</title>
    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --surface: #ffffff; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); padding: 20px; max-width: 1400px; margin: 0 auto; }
        
        /* Layout */
        .grid { display: grid; grid-template-columns: 1fr 400px; gap: 20px; }
        .card { background: var(--surface); padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        /* Controls */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { margin: 0; font-size: 1.2rem; color: #333; }
        
        /* Inputs */
        label { display: block; font-size: 0.85rem; font-weight: 600; color: #666; margin-top: 10px; margin-bottom: 4px; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        textarea { resize: vertical; min-height: 80px; }
        .row { display: flex; gap: 10px; }
        .col { flex: 1; }

        /* Images & Preview */
        .preview-img { width: 100%; border-radius: 8px; border: 1px solid #eee; }
        .icon-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 5px; }
        .icon-item { width: 50px; height: 50px; object-fit: contain; background: #fff; border: 1px solid #eee; padding: 4px; border-radius: 4px; }
        
        /* Buttons */
        button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:disabled { background: #ccc; }
        .btn-save { background: #28a745; color: white; width: 100%; margin-top: 20px; font-size: 1rem; padding: 12px; }
        .btn-save:hover { background: #218838; }

        /* Settings Overlay */
        #settings-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .settings-box { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div id="settings-overlay">
    <div class="settings-box">
        <h3 style="margin-top:0">üîê Authorization Required</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:15px">Enter your details to edit the database.</p>
        
        <label>GitHub Username</label>
        <input type="text" id="gh-username" placeholder="e.g. shanky">
        
        <label>Repository Name</label>
        <input type="text" id="gh-repo" placeholder="e.g. TakatExercises">
        
        <label>Fine-grained Token</label>
        <input type="password" id="gh-token" placeholder="github_pat_...">
        
        <button class="btn-primary" style="width:100%; margin-top:20px" onclick="saveSettings()">Access Database</button>
    </div>
</div>

<div class="top-bar">
    <button class="btn-primary" onclick="changeRecord(-1)">‚Üê Previous</button>
    <h2 id="record-title">Loading...</h2>
    <button class="btn-primary" onclick="changeRecord(1)">Next ‚Üí</button>
</div>

<div class="grid">
    <div class="card">
        <div class="row">
            <div class="col"><label>ID</label><input type="text" id="id"></div>
            <div class="col"><label>Code</label><input type="text" id="code"></div>
        </div>
        
        <label>Name</label>
        <input type="text" id="name">
        
        <label>Description</label>
        <textarea id="description" style="height: 120px"></textarea>
        
        <label>Equipments (Comma separated)</label>
        <input type="text" id="equipments">
        
        <label>Primary Muscles (Comma separated)</label>
        <input type="text" id="primary_muscles">

        <label>Secondary Muscles (Comma separated)</label>
        <input type="text" id="secondary_muscles">
        
        <label>Steps (One per line)</label>
        <textarea id="steps" style="height: 200px"></textarea>

        <button class="btn-save" id="save-btn" onclick="saveToGitHub()">üíæ Save Changes</button>
        <p id="status-msg" style="text-align: center; margin-top: 10px; font-weight: bold; min-height: 20px;"></p>
    </div>

    <div class="card" style="height: fit-content;">
        <label>Visual Preview</label>
        <div id="image-container" style="margin-bottom: 20px; background: #eee; min-height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 8px;">
            <span style="color:#888">No Image</span>
        </div>

        <label>Equipments Required</label>
        <div id="equip-icons" class="icon-grid"></div>

        <label>Primary Muscles</label>
        <div id="muscle-icons" class="icon-grid"></div>
    </div>
</div>

<script>
    // --- MAPPINGS (From your python files) ---
    // You must fill these out manually or paste your dictionaries here 
    // to map strings like "dumbbell" to "dumbbell.png"
    // For now, I assume the filename matches the equipment name + .png
    // If not, you need to paste your Python dictionary here in JS format.
    
    // --- STATE ---
    let data = [];
    let currentIndex = 0;
    const JSON_PATH = 'aggregated_output.json'; // File at root of repo

    // --- INIT ---
    function checkAuth() {
        const u = localStorage.getItem('gh_username');
        const r = localStorage.getItem('gh_repo');
        const t = localStorage.getItem('gh_token');
        if(u && r && t) {
            document.getElementById('settings-overlay').style.display = 'none';
            loadData();
        }
    }

    function saveSettings() {
        localStorage.setItem('gh_username', document.getElementById('gh-username').value.trim());
        localStorage.setItem('gh_repo', document.getElementById('gh-repo').value.trim());
        localStorage.setItem('gh_token', document.getElementById('gh-token').value.trim());
        location.reload();
    }

    async function loadData() {
        try {
            const res = await fetch(JSON_PATH);
            if(!res.ok) throw new Error("Failed to load JSON file");
            data = await res.json();
            
            const savedIndex = localStorage.getItem('current_index');
            currentIndex = savedIndex ? parseInt(savedIndex) : 0;
            render();
        } catch (e) {
            alert("Error loading data. Ensure aggregated_output.json is in the repo root.");
        }
    }

    // --- RENDER LOGIC ---
    function render() {
        if(!data.length) return;
        const record = data[currentIndex];
        
        document.getElementById('record-title').innerText = `${currentIndex + 1} / ${data.length} : ${record.name}`;
        
        // Fill Inputs
        ['id', 'code', 'name', 'description'].forEach(key => {
            document.getElementById(key).value = record[key] || '';
        });
        
        // Handle Lists -> Strings
        const listToString = (key) => (record[key] || []).join(', ');
        document.getElementById('equipments').value = listToString('equipments_required');
        document.getElementById('primary_muscles').value = listToString('primary_muscle_groups');
        document.getElementById('secondary_muscles').value = listToString('secondary_muscle_groups');
        document.getElementById('steps').value = (record.steps || []).join('\n');

        // --- IMAGE HANDLING (The Logic Fix) ---
        const imgContainer = document.getElementById('image-container');
        let imgPath = record.csv_image_paths?.['720_path'] || record.webp_image_paths?.['720_path'];
        
        if (imgPath) {
            // Extract filename from the messy local path
            // e.g., "/Users/shanky/.../burpee.gif" -> "burpee.gif"
            const fileName = imgPath.split(/[/\\]/).pop(); 
            imgContainer.innerHTML = `<img src="assets/images/${fileName}" class="preview-img" onerror="this.style.display='none'; this.parentElement.innerText='Image not found in assets/images/'">`;
        } else {
            imgContainer.innerHTML = '<span style="color:#888">No Image path in JSON</span>';
        }

        // --- ICONS HANDLING ---
        // Helper to render icons
        const renderIcons = (containerId, items, folder) => {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            (items || []).forEach(item => {
                // Assuming Mapping: item name "Dumbbell" -> file "Dumbbell.png"
                // If your mapping is complex, we need that dictionary here. 
                // For now, trying direct name match + .png
                const cleanName = item.trim();
                // Note: File names are case sensitive in GitHub Pages!
                const iconPath = `assets/${folder}/${cleanName}.png`; 
                
                const img = document.createElement('img');
                img.src = iconPath;
                img.className = 'icon-item';
                img.title = cleanName;
                img.onerror = () => { img.style.display = 'none'; }; // Hide if not found
                container.appendChild(img);
            });
        };

        renderIcons('equip-icons', record.equipments_required, 'equipments');
        renderIcons('muscle-icons', record.primary_muscle_groups, 'muscles');
    }

    // --- ACTIONS ---
    function changeRecord(dir) {
        const newIdx = currentIndex + dir;
        if(newIdx >= 0 && newIdx < data.length) {
            currentIndex = newIdx;
            localStorage.setItem('current_index', currentIndex);
            render();
        }
    }

    async function saveToGitHub() {
        const btn = document.getElementById('save-btn');
        const msg = document.getElementById('status-msg');
        
        btn.disabled = true;
        btn.innerText = "Saving...";
        msg.innerText = "";

        // 1. Update Memory Object
        const rec = data[currentIndex];
        rec.id = document.getElementById('id').value;
        rec.code = document.getElementById('code').value;
        rec.name = document.getElementById('name').value;
        rec.description = document.getElementById('description').value;
        
        // Helper: split string to array
        const strToList = (id) => document.getElementById(id).value.split(',').map(s=>s.trim()).filter(s=>s);
        rec.equipments_required = strToList('equipments');
        rec.primary_muscle_groups = strToList('primary_muscles');
        rec.secondary_muscle_groups = strToList('secondary_muscle_groups');
        rec.steps = document.getElementById('steps').value.split('\n').map(s=>s.trim()).filter(s=>s);

        // 2. API Config
        const user = localStorage.getItem('gh_username');
        const repo = localStorage.getItem('gh_repo');
        const token = localStorage.getItem('gh_token');
        const url = `https://api.github.com/repos/${user}/${repo}/contents/${JSON_PATH}`;

        try {
            // Get SHA
            const getReq = await fetch(url, { headers: { Authorization: `token ${token}` } });
            if(!getReq.ok) throw new Error("Auth failed or file not found.");
            const getJson = await getReq.json();

            // Push Update
            const contentEncoded = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 4))));
            
            const putReq = await fetch(url, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Updated: ${rec.name}`,
                    content: contentEncoded,
                    sha: getJson.sha
                })
            });

            if(!putReq.ok) throw new Error("Write failed.");
            
            msg.innerText = "‚úÖ Saved to GitHub!";
            msg.style.color = "green";
        } catch (e) {
            msg.innerText = "‚ùå Error: " + e.message;
            msg.style.color = "red";
        } finally {
            btn.disabled = false;
            btn.innerText = "üíæ Save Changes";
        }
    }

    // Start
    checkAuth();
</script>
</body>
</html>