<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Takat Exercises Editor</title>
    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --surface: #ffffff; --border: #dee2e6; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }
        
        /* --- Main Layout --- */
        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden; /* Prevent body scroll */
            max-width: 1600px;
            margin: 20px auto;
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            height: calc(100vh - 40px);
        }

        /* --- Left Vertical Tabs --- */
        .left-tabs-container {
            width: 50px;
            background: #f1f3f5;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding-top: 20px;
        }

        .v-tab-btn {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            padding: 20px 15px;
            border: none;
            background: transparent;
            color: #555;
            font-weight: 600;
            cursor: pointer;
            text-align: center;
            white-space: nowrap;
            border-left: 3px solid transparent;
            transition: all 0.2s;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .v-tab-btn:hover {
            background: #e9ecef;
            color: var(--primary);
        }

        .v-tab-btn.active {
            background: var(--surface);
            color: var(--primary);
            border-left: 3px solid var(--primary);
            /* Extend over the border */
            margin-right: -1px;
            padding-right: 16px;
            z-index: 2;
        }

        /* --- Main Content Area --- */
        .main-content-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            position: relative;
            z-index: 1;
        }

        .main-panel {
            display: none;
        }
        .main-panel.active {
            display: block;
        }
        
        /* --- Editor Grid (Home Panel) --- */
        .grid { display: grid; grid-template-columns: 1fr 500px; gap: 30px; }
        .card { background: var(--surface); padding: 25px; border-radius: 12px; border: 1px solid var(--border); }
        
        /* Controls */
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        h2 { margin: 0; font-size: 1.4rem; color: #333; }
        
        /* Inputs */
        label { display: block; font-size: 0.9rem; font-weight: 700; color: #444; margin-top: 15px; margin-bottom: 6px; }
        input, textarea { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 14px; }
        .row { display: flex; gap: 15px; }
        .col { flex: 1; }

        /* Preview */
        .preview-box { background: #e9ecef; min-height: 300px; display: flex; align-items: center; justify-content: center; border-radius: 8px; margin-bottom: 20px; overflow: hidden; border: 1px solid #dee2e6; }
        .preview-img { width: 100%; height: auto; display: block; }
        
        /* Icons (Right Side) */
        .icon-grid { display: flex; flex-wrap: wrap; gap: 15px; margin-top: 10px; }
        .icon-wrapper { text-align: center; width: 110px; display: flex; flex-direction: column; align-items: center; }
        .icon-item { width: 100px; height: 100px; object-fit: contain; background: #fff; border: 1px solid #e0e0e0; padding: 8px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .icon-label { font-size: 13px; color: #333; margin-top: 6px; line-height: 1.3; white-space: normal; word-wrap: break-word; }

        /* --- Reference Library Tabs (Muscles & Equipments) --- */
        .ref-header { font-size: 1.5rem; font-weight: bold; margin-bottom: 20px; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .ref-grid { display: flex; flex-wrap: wrap; gap: 20px; }
        .ref-card {
            display: flex; flex-direction: column; align-items: center;
            width: 130px; padding: 15px;
            border: 1px solid #eee; border-radius: 12px;
            cursor: pointer; transition: all 0.2s; background: #fff;
        }
        .ref-card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.1); transform: translateY(-3px); border-color: var(--primary); }
        .ref-card-icon {
            width: 100px; height: 100px; /* BIGGER IMAGES */
            object-fit: contain; margin-bottom: 10px;
        }
        .ref-card-label { font-size: 13px; text-align: center; word-break: break-word; font-weight: 500; color: #333; }
        .ref-copy-hint { font-size: 10px; color: var(--primary); text-transform: uppercase; margin-top: auto; font-weight: 700; opacity: 0; transition: 0.2s; }
        .ref-card:hover .ref-copy-hint { opacity: 1; }

        /* Buttons */
        button { cursor: pointer; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-save { background: #28a745; color: white; width: 100%; margin-top: 25px; font-size: 1.1rem; padding: 15px; }
        .btn-save:hover { background: #218838; }
        .btn-save:disabled { background: #94d3a2; cursor: not-allowed; }

        /* Settings Overlay */
        #settings-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(2px); }
        .settings-box { background: white; padding: 40px; border-radius: 16px; width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 30px; transform: translateX(-50%); font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body>

<div id="toast">Copied to clipboard!</div>

<div id="settings-overlay">
    <div class="settings-box">
        <h3 style="margin-top:0; font-size: 1.5rem;">üîê Authorization</h3>
        <p style="font-size:1rem; color:#666; margin-bottom:20px">Please enter your GitHub access details.</p>
        <label>GitHub Username</label> <input type="text" id="gh-username">
        <label>Repository Name</label> <input type="text" id="gh-repo">
        <label>Fine-grained Token</label> <input type="password" id="gh-token">
        <button class="btn-primary" style="width:100%; margin-top:25px; padding: 15px;" onclick="saveSettings()">Access Database</button>
    </div>
</div>

<div class="app-container">
    <div class="left-tabs-container">
        <button class="v-tab-btn active" onclick="switchMainTab('home-panel', this)">Home</button>
        <button class="v-tab-btn" onclick="switchMainTab('muscles-panel', this)">Muscles</button>
        <button class="v-tab-btn" onclick="switchMainTab('equipments-panel', this)">Equipments</button>
    </div>

    <div class="main-content-container">
        
        <div id="home-panel" class="main-panel active">
            <div class="top-bar">
                <button class="btn-primary" onclick="changeRecord(-1)">‚Üê Previous</button>
                <h2 id="record-title">Loading...</h2>
                <button class="btn-primary" onclick="changeRecord(1)">Next ‚Üí</button>
            </div>

            <div class="grid">
                <div class="card">
                    <div class="row">
                        <div class="col"><label>ID</label><input type="text" id="id"></div>
                        <div class="col"><label>Code</label><input type="text" id="code"></div>
                    </div>
                    <label>Name</label> <input type="text" id="name">
                    <label>Description</label> <textarea id="description" style="height: 100px"></textarea>
                    
                    <div class="row">
                        <div class="col"><label>Equipments</label><textarea id="equipments" style="height: 80px"></textarea></div>
                        <div class="col"><label>Primary Muscles</label><textarea id="primary_muscles" style="height: 80px"></textarea></div>
                    </div>
                    <label>Secondary Muscles</label> <input type="text" id="secondary_muscles">
                    <label>Steps</label> <textarea id="steps" style="height: 150px"></textarea>

                    <button class="btn-save" id="save-btn" onclick="saveToGitHub()">üíæ Save Changes</button>
                    <p id="status-msg" style="text-align: center; margin-top: 15px; font-weight: bold; min-height: 20px;"></p>
                </div>

                <div class="card" style="height: fit-content;">
                    <label>Exercise Preview (Merged 360)</label>
                    <div id="image-container" class="preview-box"></div>
                    <div style="text-align: center; font-size: 0.75rem; color: #999; word-break: break-all;" id="img-path-debug"></div>

                    <label style="font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 30px;">Equipments</label>
                    <div id="equip-icons" class="icon-grid"></div>

                    <label style="font-size: 1.1rem; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 30px;">Primary Muscles</label>
                    <div id="muscle-icons" class="icon-grid"></div>
                </div>
            </div>
        </div>

        <div id="muscles-panel" class="main-panel">
            <div class="ref-header">Muscles Library (Click to Copy)</div>
            <div id="muscles-grid" class="ref-grid"></div>
        </div>

        <div id="equipments-panel" class="main-panel">
            <div class="ref-header">Equipments Library (Click to Copy)</div>
            <div id="equipments-grid" class="ref-grid"></div>
        </div>

    </div>
</div>

<script>
    // --- MAPPINGS ---
    const muscles_mapping = {
        'Pectoralis Major': 'pectoralis_major.png', 'Deltoids': 'deltoids.png', 'Biceps Brachii': 'biceps_brachii.png',
        'Triceps Brachii': 'triceps_brachii.png', 'Latissimus Dorsi': 'latissimus_dorsi.png', 'Gluteus Maximus': 'gluteus_maximus.png',
        'Quadriceps': 'quadriceps.png', 'Hamstrings': 'hamstrings.png', 'Rectus Abdominis': 'rectus_abdominis.png',
        'Serratus Anterior': 'serratus_anterior.png', 'Trapezius': 'trapezius.png', 'Erector Spinae': 'erector_spinae.png',
        'Forearm Extensors': 'wrist_extensors.png', 'Forearm Flexors': 'wrist_flexors.png', 'Adductors': 'adductors.png',
        'Calves': 'calves.png', 'Obliques': 'obliques.png', 'Hip Flexors': 'hip_flexors.png', 'Rhomboids': 'rhomboids.png',
        'Infraspinatus': 'infraspinatus.png', 'Gluteus Medius': 'gluteus_medius.png', 'Tensor Fasciae Latae': 'tensor_fasciae_latae.png',
        'Tibialis Anterior': 'tibialis_anterior.png', 'Brachialis': 'brachialis.png', 'Teres Major': 'teres_major.png',
        'Brachioradialis': 'brachioradialis.png', 'Ankle Stabilizers': 'ankle_stabilizers.png', 'Teres Minor': 'teres_minor.png',
        'Supraspinatus': 'supraspinatus.png', 'Sternocleidomastoid': 'sternocleidomastoid.png', 'Scalenes': 'scalenes.png',
        'Levator Scapulae': 'levator_scapulae.png', 'Transverse Abdominis': 'transverse_abdominis.png', 'Piriformis': 'piriformis.png',
        'Quadratus Lumborum': 'quadratus_lumborum.png', 'Deep Neck Flexors': 'deep_neck_flexors.png', 'Suprahyoid': 'suprahyoid.png',
        'Intercostals': 'intercostals.png', 'Splenius Muscles': 'splenius_muscles.png', 'Semispinalis Capitis': 'semispinalis_capitis.jpeg',
        'Soleus': 'soleus.png', 'Peroneals': 'peroneals.png', 'Tibialis Posterior': 'tibialis_posterior.jpeg', 'Subscapularis': 'subscapularis.png',
        'Gluteus Minimus': 'gluteus_minimus.png', 'Iliopsoas': 'iliopsoas.png', 'Pronator Teres': 'pronator_teres.png',
        'Pronator Quadratus': 'pronator_quadratus.jpeg', 'Supinator': 'supinator.png', 'Plantar Fascia': 'plantar_fascia.png',
        'Intrinsic Foot Muscles': 'intrinsic_foot_muscles.png', 'Thenar Muscles': 'thenar_muscles.jpeg', 'Intrinsic Hand Muscles': 'intrinsic_hand_muscles.jpg',
        'Sartorius': 'sartorius.png', 'Pectoralis Minor': 'pectoralis_minor.png', 'Diaphragm': 'diaphragm.jpg', 'Foot Extensors': 'foot_extensors.png',
        'Popliteus': 'popliteus', 'Pectineus': 'pectineous.png'
    };

    const equipments_mapping = {
        'Bodyweight': 'bodyweight.png', 'Wall': 'wall.png', 'Partner': 'partner.png', 'Dumbbells': 'dumbbells.png',
        'Bosu Ball': 'bosu_ball.png', 'Kettlebell': 'kettlebell.png', 'Barbell': 'barbell.png',
        'Triceps Press Down Rope Double Grip': 'triceps_press_down_rope_double_grip.png', 'Single Column Pulley Cable Machine': 'cable_pulley_tower.png',
        '20 Inch Revolving Straight Bar': '20inch_revolving_straight_bar.png', '24 Inch Pro Style Revolving Lat Bar': '24inch_pro_style_revolving_lat_bar.png',
        '28 Inch Revolving Curl Bar': '28inch_revolving_curl_bar.png', '34 Inch Pro Style Revolving Lat Bar': '34inch_pro_style_revolving_lat_bar.png',
        '36 Inch Revolving Lat Bar': '36inch_revolving_lat_bar.png', '48 Inch Revolving Lat Bar': '48inch_revolving_lat_bar.png',
        'Ab Coaster': 'ab_coaster.png', 'Ab Crunch Machine': 'ab_crunch_machine.png', 'Ab Roller': 'ab_roller.png',
        'Abdominal Bench': 'abdominal_bench.png', 'Abdominal Seated Crunch Machine': 'abdominal_seated_crunch_machine.png', 'Adjustable Bench': 'adjustable_bench.png',
        'Aerobic Platform': 'aerobic_platform.png', 'Agility Ladder': 'agility_ladder.png', 'Air Bike': 'air_bike.png', 'Ankle Strap': 'ankle_strap.png',
        'Ankle Weights': 'ankle_weights.png', 'Arm Extension Machine': 'arm_extension_machine.png', 'Assisted Dip Machine': 'assisted_dip_machine.png',
        'Barbell Pad': 'barbell_pad.png', 'Battle Ropes': 'battle_ropes.png', 'Bench Press': 'bench_press.png', 'Flat Bench': 'bench.png', 'Blocks': 'blocks.png',
        'Bosu Ball With Handles': 'bosu_ball_with_handles.png', 'Cable Crossover Machine': 'cable_crossover_machine.png', 'Captains Chair': 'captains_chair.png',
        'Chair': 'chair.png', 'Chest Fly Machine': 'chest_fly_machine.png', 'Climbing Rope': 'climbing_rope.png', 'Cones': 'cones.png',
        'Decline Bench Press': 'decline_bench_press.png', 'Decline Bench': 'decline_bench.png', 'Deluxe Stirrup Handle': 'deluxe_stirrup_handle.png',
        'Dip Bars': 'dip_bars.png', 'Dip Station': 'dip_station.png', 'Dragging Sled': 'dragging_sled.png', 'Dual Cable Machine': 'dual_cable_machine.png',
        'Elliptical Trainer': 'elliptical_trainer.png', 'Exercise Mat': 'exercise_mat.png', 'EZ Curl Bar': 'ez_curl_bar.png', 'Front Pull Down Machine': 'front_pull_down_machine.png',
        'Functional Trainer': 'functional_trainer.png', 'Glute Ham Developer': 'glute_ham_developer.png', 'Glute Kick-back Machine': 'glute_kick_back_machine.png',
        'Gymnastic Rings': 'gymnastic_rings.png', 'Hack Squat Machine': 'hack_squat_machine.png', 'Head Harness': 'head_harness.png',
        'Hip Abductor Adductor': 'hip_abductor_adductor.png', 'Hyperextension Roman Chair': 'hyperextension_roman_chair.png', 'Incline Bench Press': 'incline_bench_press.png',
        'Incline Pectoral Fly': 'incline_pectoral_fly.png', 'Indoor Bike': 'indoor_bike.png', 'Jump Rope': 'jump_rope.png', 'Kneeling Leg Curl Machine': 'kneeling_leg_curl_machine.png',
        'Lat Pull Down Machine': 'lat_pull_down_machine.png', 'Lateral Raise': 'lateral_raise.png', 'Leg Curl Machine': 'leg_curl_machine.png',
        'Leg Extension Machine': 'leg_extension_machine.png', 'Leg Press': 'leg_press.png', 'Leg Raise Pullup Dip Tower': 'leg_raise_pullup_dip_tower.png',
        'Lever Deadlift Machine': 'lever_deadlift_machine.png', 'Lever Front Pulldown Machine': 'lever_front_pulldown_machine.png', 'Lever Preacher Curl Machine': 'lever_preacher_curl_machine.png',
        'Low Seated Row Machine': 'low_seated_row_machine.png', 'Lying Chest Press': 'lying_chest_press.png', 'Lying Leg Curl Machine': 'lying_leg_curl_machine.png',
        'Medicine Ball': 'medicine_ball.png', 'Mini Trampoline': 'mini_trampoline.png', 'Multi Exercise Bar': 'multi_exercise_bar.png', 'Multi Purpose V Bar': 'multi_purpose_v_bar.png',
        'Olympic Decline Bench': 'olympic_decline_bench.png', 'Olympic Flat Bench': 'olympic_flat_bench.png', 'Parallel Chest Press': 'parallel_chest_press.png',
        'Plate Loaded Shoulder Press': 'plate_loaded_shoulder_press.png', 'Plyo Box': 'plyo_box.png', 'Power Rack': 'power_rack.png', 'Preacher Curl Bench': 'preacher_curl_bench.png',
        'Pull-up Bar': 'pull_up_bar.png', 'Recumbent Exercise Bike': 'recumbent_exercise_bike.png', 'Resistance Band With Handles': 'resistance_band_with_handles.png',
        'Resistance Band': 'resistance_band.png', 'Reverse Hyper Machine': 'reverse_hyper_machine.png', 'Rotary Torso Machine': 'rotary_torso_machine.png',
        'Rowing Machine': 'rowing_machine.png', 'Seated Calf Raise': 'seated_calf_raise.png', 'Seated Dip Machine': 'seated_dip_machine.png',
        'Seated Row Chinning Bar': 'seated_row_chinning_bar.png', 'Selectorised Recumbent Leg Press': 'selectorised_recumbent_leg_press.png', 'Shoulder Press': 'shoulder_press.png',
        'Sliders': 'sliders.png', 'Smith Machine': 'smith_machine.png', 'Stability Ball': 'stability_ball.png', 'Standing Calf Machine': 'standing_calf_machine.png',
        'Standing Chest Press': 'standing_chest_press.png', 'Suspension Trainers': 'suspension_trainers.png', 'T-bar Row Machine': 't_bar_row_machine.png',
        'Trap Bar': 'trap_bar.png', 'Treadmill': 'treadmill.png', 'Triceps Bar': 'triceps_bar.png', 'Triceps Full Extension Bar': 'triceps_full_extension_bar.png',
        'Triceps Hammer Rope Single Grip': 'triceps_hammer_rope_single_grip.png', 'Triceps Press Down Bar': 'triceps_press_down_bar.png', 'Triceps Press Machine': 'triceps_press_machine.png',
        'Twist Disk Machine': 'twist_disk_machine.png', 'Under Desk Pedal': 'under_desk_pedal.png', 'Weight Plates': 'weight_plates.png', 'Hula Hoop': 'hula_hoop.png',
        'Sissy Squat Machine': 'sissy_squat_machine.png', 'Plate-Loaded High Row Machine': 'plate_loaded_high_row_machine.png', 'Rocker Board': 'rocker_board.png',
        'Massage Ball': 'massage_ball.png', 'Ab Pad': 'ab_pad.png', 'Towel': 'towel.png', 'Therapy Table': 'therapy_table.png',
        'Plate-Loaded Incline Chest Press Machine': 'plate_loaded_incline_chest_press_machine.png', 'Parallel Grip Lat Pulldown Bar': 'parallel_grip_lat_pulldown_bar.png',
        'Power Twister': 'power_twister.png', 'Vertical Climbing Ladder': 'vertical_climbing_ladder.png', 'Lever Decline Chest Press Machine': 'lever_decline_chest_press_machine.png',
        'Seated Converging Chest Press Machine': 'seated_converging_chest_press_machine.png', 'Lever Chair Squat Machine': 'lever_chair_squat_machine.png',
        'Standing Glute Kick-back Machine': 'standing_glute_kickback_machine.png', 'Tib Bar': 'tib_bar.png', 'Lever Bent-over Row Machine': 'lever_bent_over_row_machine.png',
        'Landmine': 'landmine.png', 'Stick': 'stick.png', 'Triceps Extension Machine': 'tricep_extension_machine.png', 'Power Squat Machine': 'power_squat_machine.png'
    };

    // --- APP LOGIC ---
    let data = [];
    let currentIndex = 0;
    const JSON_PATH = 'aggregated_output.json'; 

    function checkAuth() {
        const u = localStorage.getItem('gh_username');
        const r = localStorage.getItem('gh_repo');
        const t = localStorage.getItem('gh_token');
        if(u && r && t) { document.getElementById('settings-overlay').style.display = 'none'; loadData(); }
        
        // Initialize main tabs and render libraries
        switchMainTab('home-panel', document.querySelector('.v-tab-btn.active'));
        renderRefTabs();
    }

    function saveSettings() {
        localStorage.setItem('gh_username', document.getElementById('gh-username').value.trim());
        localStorage.setItem('gh_repo', document.getElementById('gh-repo').value.trim());
        localStorage.setItem('gh_token', document.getElementById('gh-token').value.trim());
        location.reload();
    }

    async function loadData() {
        try {
            const res = await fetch(JSON_PATH);
            if(!res.ok) throw new Error("Failed to load JSON");
            data = await res.json();
            const savedIndex = localStorage.getItem('current_index');
            currentIndex = savedIndex ? parseInt(savedIndex) : 0;
            render();
        } catch (e) { alert("Could not load data."); }
    }

    // --- MAIN TAB LOGIC ---
    function switchMainTab(panelId, btnElement) {
        // 1. Deactivate all panels and buttons
        document.querySelectorAll('.main-panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.v-tab-btn').forEach(b => b.classList.remove('active'));
        
        // 2. Activate the selected panel and button
        document.getElementById(panelId).classList.add('active');
        btnElement.classList.add('active');
    }

    function renderRefTabs() {
        const createGrid = (containerId, mapping, folder) => {
            const container = document.getElementById(containerId);
            const keys = Object.keys(mapping).sort();
            
            keys.forEach(key => {
                const card = document.createElement('div');
                card.className = 'ref-card';
                card.onclick = () => {
                    navigator.clipboard.writeText(key);
                    const t = document.getElementById("toast");
                    t.innerText = `Copied: ${key}`;
                    t.className = "show";
                    setTimeout(() => { t.className = t.className.replace("show", ""); }, 3000);
                };

                const img = document.createElement('img');
                img.src = `assets/${folder}/${mapping[key]}`;
                img.className = 'ref-card-icon';
                
                const label = document.createElement('div');
                label.className = 'ref-card-label';
                label.innerText = key;
                
                const hint = document.createElement('div');
                hint.className = 'ref-copy-hint';
                hint.innerText = "CLICK TO COPY";

                card.appendChild(img);
                card.appendChild(label);
                card.appendChild(hint);
                container.appendChild(card);
            });
        };

        createGrid('muscles-grid', muscles_mapping, 'muscles');
        createGrid('equipments-grid', equipments_mapping, 'equipments');
    }

    function render() {
        if(!data.length) return;
        const record = data[currentIndex];
        document.getElementById('record-title').innerText = `${currentIndex + 1} / ${data.length} : ${record.name}`;
        
        ['id', 'code', 'name', 'description'].forEach(k => document.getElementById(k).value = record[k] || '');
        const listStr = (k) => (record[k] || []).join(', ');
        document.getElementById('equipments').value = listStr('equipments_required');
        document.getElementById('primary_muscles').value = listStr('primary_muscle_groups');
        document.getElementById('secondary_muscles').value = listStr('secondary_muscle_groups');
        document.getElementById('steps').value = (record.steps || []).join('\n');

        // --- IMAGE LOGIC ---
        const container = document.getElementById('image-container');
        const pathDebug = document.getElementById('img-path-debug');
        const rawPath = record.csv_image_paths?.['360_path'];

        if (rawPath) {
            const parts = rawPath.split('/merged/');
            if (parts.length > 1) {
                const webPath = `assets/images/merged/${parts[1]}`;
                container.innerHTML = `<img src="${webPath}" class="preview-img" onerror="this.onerror=null; this.parentElement.innerHTML='<span style=\'color:red\'>File not found: ${webPath}</span>'">`;
                pathDebug.innerText = webPath;
            } else { container.innerHTML = '<span style="color:orange">Path missing "/merged/"</span>'; }
        } else { container.innerHTML = '<span style="color:#999">No 360_path found</span>'; }

        // --- ICONS LOGIC ---
        renderIcons('equip-icons', record.equipments_required, equipments_mapping, 'equipments');
        renderIcons('muscle-icons', record.primary_muscle_groups, muscles_mapping, 'muscles');
    }

    function renderIcons(containerId, items, mapping, folder) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        if (!items) return;
        items.forEach(item => {
            const cleanName = item.trim();
            const fileName = mapping[cleanName];
            const wrapper = document.createElement('div');
            wrapper.className = 'icon-wrapper';
            if (fileName) {
                const img = document.createElement('img');
                img.src = `assets/${folder}/${fileName}`; 
                img.className = 'icon-item';
                img.onerror = () => { img.style.opacity = '0.3'; };
                wrapper.appendChild(img);
            } else {
                const placeholder = document.createElement('div');
                placeholder.className = 'icon-item';
                placeholder.innerText = '?';
                placeholder.style.display='flex'; placeholder.style.alignItems='center'; placeholder.style.justifyContent='center';
                wrapper.appendChild(placeholder);
            }
            const label = document.createElement('div');
            label.className = 'icon-label';
            label.innerText = cleanName;
            wrapper.appendChild(label);
            container.appendChild(wrapper);
        });
    }

    function changeRecord(dir) {
        const newIdx = currentIndex + dir;
        if(newIdx >= 0 && newIdx < data.length) {
            currentIndex = newIdx;
            localStorage.setItem('current_index', currentIndex);
            render();
        }
    }

    async function saveToGitHub() {
        const btn = document.getElementById('save-btn');
        const msg = document.getElementById('status-msg');
        
        const rec = data[currentIndex]; 
        rec.name = document.getElementById('name').value;
        rec.description = document.getElementById('description').value;
        const list = (id) => document.getElementById(id).value.split(',').map(s=>s.trim()).filter(s=>s.length > 0);
        
        rec.equipments_required = list('equipments');
        rec.primary_muscle_groups = list('primary_muscles');
        rec.secondary_muscle_groups = list('secondary_muscles'); 
        rec.steps = document.getElementById('steps').value.split('\n').map(s=>s.trim()).filter(s=>s.length > 0);

        const user = localStorage.getItem('gh_username');
        const repo = localStorage.getItem('gh_repo');
        const token = localStorage.getItem('gh_token');

        if (!user || !repo || !token) { alert("‚ùå Settings Missing"); return; }

        const baseUrl = `https://api.github.com/repos/${user.trim()}/${repo.trim()}/contents/${JSON_PATH.trim()}`;
        btn.disabled = true; btn.innerText = "Connecting..."; msg.innerText = "Connecting...";

        try {
            const getRes = await fetch(`${baseUrl}?t=${new Date().getTime()}`, { 
                headers: { Authorization: `token ${token}` } 
            });
            if (getRes.status === 404) throw new Error("File not found");
            if (getRes.status === 401) throw new Error("Token Invalid");
            if (!getRes.ok) throw new Error(`Connection Error: ${getRes.status}`);
            const getJson = await getRes.json();
            
            btn.innerText = "Uploading...";
            const content = btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))));
            
            const putRes = await fetch(baseUrl, {
                method: 'PUT',
                headers: { Authorization: `token ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: `Update ${rec.name}`, content: content, sha: getJson.sha })
            });

            if (putRes.status === 403) throw new Error("Permission Denied (Read-Only Token)");
            if (!putRes.ok) throw new Error(`Upload Failed: ${putRes.status}`);

            msg.innerText = "‚úÖ Saved Successfully!"; msg.style.color = "green";
        } catch (e) {
            console.error(e); msg.innerText = "‚ùå " + e.message; msg.style.color = "red"; alert(e.message);
        } finally {
            btn.disabled = false; btn.innerText = "üíæ Save Changes";
        }
    }

    checkAuth();
</script>
</body>
</html>